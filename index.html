<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ù†ÙˆØ§Ù‚Øµ Ø§Ù„Ù…Ø®Ø§Ø²Ù† â€” ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ… (live)</title>

  <!-- Cairo font for Arabic + Bootstrap 5 RTL (for quick responsive utilities) -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">

  <!-- Chart.js (latest) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg: #f6f8fa;
      --card: #ffffff;
      --muted: #6c757d;
      --accent: #0d6efd;
      --text: #0b2230;
      --shadow: 0 10px 30px rgba(3,10,20,0.06);
      --glass: rgba(255,255,255,0.6);
      --glass-2: rgba(255,255,255,0.04);
    }
    /* Dark mode variables (toggle-ready) */
    @media (prefers-color-scheme: dark){
      :root{
        --bg: #0b0f12;
        --card: #0f1720;
        --muted: #9aa4ad;
        --accent: #7c9cff;
        --text: #e6eef8;
        --shadow: 0 10px 30px rgba(0,0,0,0.6);
      }
      body { color:var(--text); }
    }

    html,body { height:100%; }
    body {
      font-family: "Cairo", sans-serif;
      background:linear-gradient(180deg,var(--bg), #eef3f8 60%);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.35;
      padding-bottom:48px;
    }

    .container { max-width:1200px; }

    header .small-muted { color:var(--muted); }

    .card-dashboard {
      background: linear-gradient(180deg,var(--card),rgba(255,255,255,0.96));
      border-radius:14px;
      padding:16px;
      box-shadow:var(--shadow);
      transition:transform .15s ease, box-shadow .15s ease;
      border: 1px solid var(--glass-2);
    }
    .card-dashboard:hover { transform: translateY(-4px); box-shadow: 0 14px 36px rgba(3,10,20,0.08); }

    /* KPI styles */
    .kpi {
      display:flex;
      align-items:center;
      gap:12px;
      padding:14px;
      border-radius:12px;
      background:linear-gradient(180deg, rgba(13,110,253,0.06), rgba(13,110,253,0.02));
      min-height:72px;
    }
    .kpi .value {
      font-size:1.3rem;
      font-weight:800;
      color:var(--text);
    }
    .kpi .label {
      color:var(--muted);
      font-size:0.95rem;
    }

    /* Table styles */
    .table-responsive { max-height:52vh; overflow:auto; }
    table thead th {
      position: sticky;
      top:0;
      background: linear-gradient(180deg,var(--card),var(--card));
      z-index:4;
      border-bottom: 2px solid rgba(0,0,0,0.06);
      cursor: pointer;
    }
    table tbody tr:hover { background: rgba(13,110,253,0.03); }

    .nowrap { white-space:nowrap; }

    /* Charts layout */
    .charts-grid {
      display:grid;
      grid-template-columns: 1fr 420px;
      gap:16px;
      align-items:start;
    }
    @media (max-width:980px){
      .charts-grid { grid-template-columns: 1fr; }
    }
    .chart-card { padding:16px; border-radius:14px; background:var(--card); box-shadow:var(--shadow); min-height:220px; }

    .chart-title { font-weight:700; margin-bottom:12px; }

    /* small helpers */
    .muted { color:var(--muted); font-size:0.95rem; }
    .text-xxs { font-size:0.78rem; color:var(--muted); }

    /* Refresh button */
    #btnRefresh[disabled] { opacity:0.75; pointer-events:none; }

    /* Number animation container */
    .animated-num { display:inline-block; min-width:60px; text-align:left; }

    /* Responsive table small screens */
    @media (max-width:720px){
      table thead th:nth-child(4),
      table tbody td:nth-child(4),
      table thead th:nth-child(6),
      table tbody td:nth-child(6) { display:none; }
    }

    /* Tiny spinner */
    .spinner-inline {
      width:16px; height:16px; border:2px solid rgba(0,0,0,0.08); border-top-color:var(--accent); border-radius:50%;
      display:inline-block; vertical-align:middle; animation:spin .8s linear infinite;
    }
    @keyframes spin { to{ transform:rotate(360deg);} }

    /* Empty state */
    .empty-state { text-align:center; padding:28px; color:var(--muted); }

    /* Accessibility focus */
    a:focus, button:focus, input:focus, select:focus { outline:3px solid rgba(13,110,253,0.12); outline-offset:2px; }

    /* modern legend */
    .chart-legend { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px; }
    .legend-item { display:inline-flex; gap:8px; align-items:center; font-size:0.85rem; color:var(--muted); }
    .legend-swatch { width:12px; height:12px; border-radius:3px; display:inline-block; }

  </style>
</head>
<body>
  <div class="container py-4">
    <header class="mb-3 d-flex align-items-start justify-content-between gap-3">
      <div>
        <h2 class="mb-0">Ù„ÙˆØ­Ø© Ù†ÙˆØ§Ù‚Øµ Ø§Ù„Ù…Ø®Ø§Ø²Ù† â€” ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ… (Ù…Ø¨Ø§Ø´Ø±)</h2>
        <div class="small-muted">Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ÙˆØ±Ù‚Ø© Ø¬ÙˆØ¬Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (Ø§Ù„Ø´ÙŠØª Ø§Ù„Ø£ÙŠØ³Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹). ØªÙØ¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† API Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«.
        <div class="small-muted mt-1" id="lastUpdated">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: â€”</div>
      </div>

      <div class="text-start d-flex align-items-center gap-2">
        <!-- Refresh button: re-fetches, updates KPIs, table, charts. Disabled while fetching. -->
        <button id="btnRefresh" class="btn btn-primary" aria-live="polite" title="Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <a class="btn btn-outline-secondary" href="https://github.com/Masterpiece2009/Dashboard_Inventory_shortages" target="_blank">Ù…Ø³ØªÙˆØ¯Ø¹ GitHub</a>
      </div>
    </header>

    <!-- KPIs -->
    <div class="row g-3 mb-3">
      <div class="col-12 col-md-4">
        <div class="card-dashboard d-flex justify-content-between align-items-center">
          <div>
            <div class="label muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙ†Ø§Ù</div>
            <div class="value h3"><span id="kpiTotal" class="animated-num">â€”</span></div>
            <div class="text-xxs muted">ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</div>
          </div>
          <div style="min-width:120px;text-align:left;">
            <canvas id="sparkTotal" width="120" height="40" aria-hidden="true"></canvas>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-4">
        <div class="card-dashboard d-flex justify-content-between align-items-center">
          <div>
            <div class="label muted">Ù†ÙØ°Øª Ø§Ù„ÙƒÙ…ÙŠØ©</div>
            <div class="value h3"><span id="kpiOut" class="animated-num">â€”</span></div>
            <div class="text-xxs muted">Ø£ØµÙ†Ø§Ù Ù…ÙØ³Ø¬Ù„Ø© ÙƒÙ€ "Ù†ÙØ°Øª" Ø£Ùˆ Ø±ØµÙŠØ¯ â‰¤ 0</div>
          </div>
          <div style="min-width:120px;text-align:left;">
            <canvas id="sparkOut" width="120" height="40" aria-hidden="true"></canvas>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-4">
        <div class="card-dashboard d-flex justify-content-between align-items-center">
          <div>
            <div class="label muted">Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</div>
            <div class="value h3"><span id="kpiNear" class="animated-num">â€”</span></div>
            <div class="text-xxs muted">Ø£ØµÙ†Ø§Ù Ø­Ø§Ù„Ø© "Ø¹Ù„Ù‰ ÙˆØ´Ùƒ" Ø£Ùˆ Ø±ØµÙŠØ¯ Ø¨ÙŠÙ† 1 Ùˆ 5</div>
          </div>
          <div style="min-width:120px;text-align:left;">
            <canvas id="sparkNear" width="120" height="40" aria-hidden="true"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters (placeholders for future) -->
    <div class="row mb-3">
      <div class="col-12 col-md-8">
        <div class="card-dashboard d-flex gap-2 align-items-center">
          <input id="searchBox" class="form-control form-control-sm" placeholder="Ø¨Ø­Ø« (Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù Ø£Ùˆ Ø¨Ø§Ø±ÙƒÙˆØ¯) â€” Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØµÙÙŠØ© Ù…Ø­Ù„ÙŠØ§Ù‹" />
          <div class="text-muted small">ÙÙ„ØªØ± Ø³Ø±ÙŠØ¹ Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ÙÙ„ØªØ± ÙØ¦Ø§Øª/Ø§Ù„Ø­Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… Ù„Ø§Ø­Ù‚Ø§Ù‹.</div>
        </div>
      </div>
      <div class="col-12 col-md-4 text-start">
        <div class="card-dashboard d-flex justify-content-between align-items-center">
          <div class="small-muted">Ø­Ø¬Ù… Ø§Ù„ØµÙØ­Ø©</div>
          <select id="pageSize" class="form-select form-select-sm w-auto">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Main content: charts + table -->
    <div class="row g-3">
      <div class="col-12">
        <div class="charts-grid mb-3">
          <!-- Left: Categories bar chart (modern look) -->
          <div class="chart-card">
            <div class="chart-title">Ù†ÙˆØ§Ù‚Øµ Ø­Ø³Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙ</div>
            <canvas id="categoryChart" height="300" aria-label="Ø´Ø±ÙŠØ· Ø§Ù„Ù†ÙˆØ§Ù‚Øµ Ø­Ø³Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙ"></canvas>
            <div id="catEmpty" class="empty-state" style="display:none;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§</div>
            <div class="muted mt-2">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù…Ø³Ø§Ù‡Ù…Ø© ÙÙŠ Ø§Ù„Ù†ÙˆØ§Ù‚Øµ â€” ÙŠÙ…ÙƒÙ† ØªÙˆØ³ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ± Ù„Ø§Ø­Ù‚Ø§Ù‹.</div>
          </div>

          <!-- Right: Inventory health doughnut + legend -->
          <div class="chart-card">
            <div class="chart-title">ØµØ­Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
            <canvas id="healthChart" height="220" aria-label="Ø¯ÙˆÙ†Ø§Øª ØµØ­Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†"></canvas>
            <div id="healthLegend" class="chart-legend mt-2" aria-hidden="true"></div>
            <div id="healthEmpty" class="empty-state" style="display:none;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§</div>
            <div class="muted mt-2">Ù†ÙØ°Øª / Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ / Ù…ØªÙˆÙØ±</div>
          </div>
        </div>

        <!-- Full-width: Critical delays horizontal chart -->
        <div class="chart-card mb-3">
          <div class="chart-title">Ø£ØµÙ†Ø§Ù Ø°Ø§Øª Ø£Ø·ÙˆÙ„ Ù…Ø¯Ø© ØªÙˆØ±ÙŠØ¯ (Ø£Ø¹Ù„Ù‰ 8)</div>
          <canvas id="delayChart" height="160" aria-label="ØªØ£Ø®ÙŠØ±Ø§Øª Ø­Ø±Ø¬Ø©"></canvas>
          <div id="delayEmpty" class="empty-state" style="display:none;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§</div>
          <div class="muted mt-2">Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø°Ø§Øª Ø£Ø·ÙˆÙ„ Ù…Ø¯Ø© ØªÙˆØ±ÙŠØ¯ â€” ÙŠØ³Ø§Ø¹Ø¯ ÙÙŠ ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø±Ø¬Ø©.</div>
        </div>
      </div>

      <!-- Table -->
      <div class="col-12">
        <div class="card-dashboard">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</h6>
            <div class="muted">Ø¹Ù†Ø§ØµØ±: <span id="rowsCount">â€”</span></div>
          </div>

          <div class="table-responsive">
            <table class="table table-striped table-hover table-sm" id="itemsTable">
              <thead class="table-light">
                <tr>
                  <th data-key="name">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
                  <th data-key="category">Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                  <th data-key="system_balance" class="text-end">Ø±ØµÙŠØ¯ Ø§Ù„Ø³ÙŠØ³ØªÙ…</th>
                  <th data-key="availability">ØªÙˆÙØ± Ø§Ù„Ù…Ù†ØªØ¬</th>
                  <th data-key="status">Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</th>
                  <th data-key="lead_time" class="text-center">Ù…Ø¯Ø© Ø§Ù„ØªÙˆØ±ÙŠØ¯ (ÙŠÙˆÙ…)</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>

          <nav class="mt-2">
            <ul class="pagination pagination-sm justify-content-center mb-0" id="pagination"></ul>
          </nav>
        </div>
      </div>
    </div>

    <footer class="mt-4 muted small text-center">Ù…Ø¨Ù†ÙŠ Ø¨ÙˆØ§Ø¬Ù‡Ø© Ø®ÙÙŠÙØ© ÙˆØ³Ù‡Ù„Ø© Ø§Ù„ØªÙˆØ³ÙŠØ¹ â€” Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Google Sheets (Ø§Ù„Ø´ÙŠØª Ø§Ù„Ø£ÙŠØ³Ø± Ù‡Ùˆ Ø§Ù„ÙŠÙˆÙ…)</footer>
  </div>

<script>
/*
  Improvements included:
  - Fixed normalization (previous version had an unfinished return causing charts not to render).
  - Better parsing for fields in the provided JSON sample (keys like "Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ \\ Ù…Ø±Ø¬Ø¹ Ø¯Ø§Ø®Ù„ÙŠ", "Ù…Ø¯Ø© Ø§Ù„ØªÙˆØ±ÙŠØ¯ Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨", etc).
  - Modernized Chart.js styles: gradients, center label for doughnut, small sparklines for KPIs.
  - More robust handling of "NR", empty strings and various units (e.g. "Ùƒ", "Ø·Ù†").
  - Health legend rendered as HTML for better readability on dark themes.
  - Increased default chart responsiveness and accessibility hints.
*/

/* ==========================
   Configuration / Globals
   ========================== */

const apiUrl = 'https://script.google.com/macros/s/AKfycbzXQ-Jkb-b-Y4NR4qRfXsNlw0Ljf5pxoYFrXmTEhau4noTvKHNB03MnkkWyv-6rtO2UkQ/exec';

let RAW = null;              // raw API response object
let ROWS = [];               // normalized rows used by UI
let charts = { category: null, health: null, delay: null, spark: [] };
let currentPage = 1;
let pageSize = Number(document.getElementById('pageSize').value) || 20;
let sortKey = null, sortDir = 1;

/* Chart.js global defaults for Arabic font */
if (window.Chart) {
  Chart.defaults.font.family = '"Cairo", "Noto Sans Arabic", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial';
  Chart.defaults.plugins.tooltip.titleFont = { family: Chart.defaults.font.family, weight: '700' };
}

/* Shared color palette and helpers for charts */
const chartColors = {
  red: '#ef4444',
  orange: '#fb923c',
  green: '#10b981',
  blue: '#3b82f6',
  purple: '#7c3aed',
  gray: '#6c757d'
};

/* Simple utility: safe parse number (handles "NR", null, "", "1,234 Ùƒ", "2.5 Ø·Ù†", etc.) */
function parseNum(value){
  if (value === null || value === undefined) return NaN;
  if (typeof value === 'number') return value;
  const s = String(value).trim();
  if (!s || s.toLowerCase() === 'nr' || s.toLowerCase() === 'n/a' || s === '-') return NaN;
  // Replace Arabic commas, replace arabic digits if any (we'll keep simple)
  const normalized = s.replace(/[Ù¬,]/g, '').replace(/Ùƒ\b|Ùƒ\./g,'').replace(/ÙƒØº|ÙƒØ¬Ù…/g,'').replace(/\s*Ø·Ù†\b/gi, ''); // remove unit characters
  // Remove any non digit/dot/minus
  const cleaned = normalized.replace(/[^\d.\-]/g,'');
  const n = Number(cleaned);
  return isNaN(n) ? NaN : n;
}

/* Format number for display */
function fmtNum(n){
  if (n === null || n === undefined || isNaN(Number(n))) return '-';
  const num = Number(n);
  // Use Arabic-Indic digits for better locale feel? keep western for readability
  return Number.isInteger(num) ? num.toLocaleString('en-US') : num.toLocaleString('en-US');
}

/* Animate numeric value in element from 0 to target */
function animateValue(el, start, end, duration=700){
  start = Number(start) || 0;
  end = Number(end) || 0;
  const range = end - start;
  if (Math.abs(range) < 1){
    el.textContent = fmtNum(end);
    return;
  }
  const startTime = performance.now();
  function step(now){
    const t = Math.min(1, (now - startTime) / duration);
    const eased = (--t)*t*t+1; // easeOutCubic
    const current = Math.round(start + (range * eased));
    el.textContent = fmtNum(current);
    if (now - startTime < duration) requestAnimationFrame(step);
    else el.textContent = fmtNum(end);
  }
  requestAnimationFrame(step);
}

/* ================
   DOM references
   ================ */
const btnRefresh = document.getElementById('btnRefresh');
const lastUpdatedEl = document.getElementById('lastUpdated');
const kpiTotalEl = document.getElementById('kpiTotal');
const kpiOutEl = document.getElementById('kpiOut');
const kpiNearEl = document.getElementById('kpiNear');
const tbody = document.getElementById('tbody');
const rowsCountEl = document.getElementById('rowsCount');
const paginationEl = document.getElementById('pagination');
const searchBox = document.getElementById('searchBox');
const pageSizeEl = document.getElementById('pageSize');

/* --------------------------
   Fetch data from remote API
   -------------------------- */
async function fetchData(){
  try {
    btnRefresh.disabled = true;
    const originalText = btnRefresh.textContent;
    btnRefresh.innerHTML = 'ğŸ”„ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ø¯ÙŠØ« <span class="spinner-inline" aria-hidden="true"></span>';

    const resp = await fetch(apiUrl, {cache: 'no-store'});
    if (!resp.ok) throw new Error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + resp.status);
    const json = await resp.json();

    RAW = json;
    lastUpdatedEl.textContent = `Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${formatGeneratedAt(RAW.generatedAt)}`;

    // Normalize rows (map Arabic keys to consistent keys we use)
    ROWS = normalizeRows(RAW.rows || []);

    // reset pagination and rendering
    currentPage = 1;
    pageSize = Number(pageSizeEl.value) || 20;

    // render everything
    calculateAndRenderAll();

  } catch(err){
    console.error(err);
    alert('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø£Ùˆ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© API.\n' + (err.message||''));
  } finally {
    btnRefresh.disabled = false;
    btnRefresh.textContent = 'ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
  }
}

/* Helper: format generatedAt string into Arabic-friendly time */
function formatGeneratedAt(iso){
  if (!iso) return '-';
  try {
    const d = new Date(iso);
    return d.toLocaleString('ar-EG', { dateStyle:'medium', timeStyle:'short' });
  } catch(e){ return iso; }
}

/* ===========================
   Normalize input rows to stable object shape
   Returned object:
   {
     barcode, name, category, system_balance (number|null),
     availability, status, lead_time (number|null), raw
   }
*/
function normalizeRows(rawRows){
  if (!Array.isArray(rawRows)) return [];
  return rawRows.map(r => {
    // many sheets use slightly different Arabic keys; we detect by contains rather than exact match
    function pickByPossible(keys){
      for (const k of keys){
        if (k in r) return r[k];
      }
      // fallback: search keys that include a substring
      for (const key of Object.keys(r)){
        for (const k of keys){
          if (key && key.toString().includes(k)) return r[key];
        }
      }
      return undefined;
    }

    // barcode: look for keys containing "Ø¨Ø§Ø±ÙƒÙˆØ¯" or "Ù…Ø±Ø¬Ø¹"
    let barcode = undefined;
    for (const key of Object.keys(r)){
      if (String(key).includes('Ø¨Ø§Ø±ÙƒÙˆØ¯') || String(key).includes('Ù…Ø±Ø¬Ø¹')) { barcode = r[key]; break; }
    }
    // friendly fallbacks
    barcode = barcode ?? pickByPossible(['barcode','Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯','Barcode']);

    const name = pickByPossible(['Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù','Ø§Ø³Ù…_Ø§Ù„ØµÙ†Ù','Name','name']) ?? '';
    const category = pickByPossible(['Ø§Ù„ØªØµÙ†ÙŠÙ','Ø§Ù„ØµÙ†Ù','Category','category']) ?? 'Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙ';

    // system balance field variations
    const balanceRaw = pickByPossible(['Ø±ØµÙŠØ¯ Ø§Ù„Ø³ÙŠØ³ØªÙ…','Ø±ØµÙŠØ¯_Ø§Ù„Ø³ÙŠØ³ØªÙ…','system_balance','balance','Ø±ØµÙŠØ¯']);
    const system_balance = (() => { const n = parseNum(balanceRaw); return isNaN(n) ? null : n; })();

    const availability = pickByPossible(['ØªÙˆÙØ± Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ù…Ø¹ØµØ±Ø©','ØªÙˆÙØ± Ø§Ù„Ù…Ù†ØªØ¬','availability']) ?? '';
    const status = pickByPossible(['Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨','Ø§Ù„Ø­Ø§Ù„Ø©','status']) ?? '';

    // lead time variations: "Ù…Ø¯Ø© Ø§Ù„ØªÙˆØ±ÙŠØ¯ Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨" etc
    const leadRaw = pickByPossible(['Ù…Ø¯Ø© Ø§Ù„ØªÙˆØ±ÙŠØ¯ Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨','Ù…Ø¯Ø© Ø§Ù„ØªÙˆØ±ÙŠØ¯','lead_time','leadTime']);
    const lead_time = (() => { const n = parseNum(leadRaw); return isNaN(n) ? null : n; })();

    // keep original raw for searching & debugging
    return {
      barcode,
      name: String(name || '').trim(),
      category: String(category || '').trim(),
      system_balance,
      availability: String(availability || '').trim(),
      status: String(status || '').trim(),
      lead_time,
      raw: r
    };
  });
}

/* =========================
   KPI calculation and render
   ========================= */
function calculateKPIs(data){
  const total = data.length;
  // Out of stock: explicit availability/status mentions OR system_balance <= 0
  const out = data.filter(d => {
    const av = (d.availability || '').toLowerCase();
    const st = (d.status || '').toLowerCase();
    if (av.includes('Ù†ÙØ°Øª') || st.includes('Ù†ÙØ°Øª')) return true;
    if (d.system_balance !== null && d.system_balance <= 0) return true;
    return false;
  }).length;

  // Near out: mentions "Ø¹Ù„Ù‰ ÙˆØ´Ùƒ" or system_balance 1..5
  const near = data.filter(d => {
    const av = (d.availability || '').toLowerCase();
    const st = (d.status || '').toLowerCase();
    if (av.includes('Ø¹Ù„ÙŠ ÙˆØ´Ùƒ') || av.includes('Ø¹Ù„Ù‰ ÙˆØ´Ùƒ') || st.includes('Ø¹Ù„ÙŠ ÙˆØ´Ùƒ') || st.includes('Ø¹Ù„Ù‰ ÙˆØ´Ùƒ')) return true;
    if (d.system_balance !== null && d.system_balance > 0 && d.system_balance <= 5) return true;
    return false;
  }).length;

  return { total, out, near };
}

function renderKPIs(kpis){
  animateValue(kpiTotalEl, 0, kpis.total, 600);
  animateValue(kpiOutEl, 0, kpis.out, 700);
  animateValue(kpiNearEl, 0, kpis.near, 700);

  // draw tiny sparklines to give visual feedback (simple bars)
  renderSparkline('sparkTotal', [kpis.total, Math.max(0, kpis.total - 3), kpis.total], chartColors.blue);
  renderSparkline('sparkOut', [kpis.out, Math.max(0, kpis.out - 2), kpis.out], chartColors.red);
  renderSparkline('sparkNear', [kpis.near, Math.max(0, kpis.near - 1), kpis.near], chartColors.orange);
}

/* tiny sparkline renderer */
function renderSparkline(canvasId, data, color){
  try{
    const el = document.getElementById(canvasId);
    if (!el) return;
    const ctx = el.getContext('2d');
    // destroy previous if exists
    if (charts.spark[canvasId]) try { charts.spark[canvasId].destroy(); } catch(e){}
    charts.spark[canvasId] = new Chart(ctx, {
      type: 'line',
      data: { labels: data.map((_,i)=>i), datasets: [{ data, borderColor: color, backgroundColor: color+'22', fill:true, tension:0.4, pointRadius:0 }] },
      options: { responsive:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{display:false}}, elements:{line:{borderWidth:2}} }
    });
  }catch(e){ console.warn(e); }
}

/* =========================
   Table rendering & pagination
   ========================= */
function renderTable(data){
  const q = (searchBox.value || '').trim().toLowerCase();

  // local filter by search box (name or barcode if exists)
  let filtered = data.filter(r => {
    if (!q) return true;
    // include raw row values to search any field and barcode
    const combined = Object.values(r.raw || {}).join(' ').toLowerCase();
    const bn = String(r.barcode || '').toLowerCase();
    return combined.includes(q) || (r.name || '').toLowerCase().includes(q) || bn.includes(q);
  });

  // sorting if any
  if (sortKey){
    filtered.sort((a,b) => {
      let va = a[sortKey], vb = b[sortKey];
      if (sortKey === 'system_balance' || sortKey === 'lead_time'){
        va = (va === null) ? NaN : va;
        vb = (vb === null) ? NaN : vb;
        return ((isNaN(va) ? -Infinity : va) - (isNaN(vb) ? -Infinity : vb)) * sortDir;
      }
      va = String(va || '').toLowerCase();
      vb = String(vb || '').toLowerCase();
      return va > vb ? sortDir : va < vb ? -sortDir : 0;
    });
  }

  const total = filtered.length;
  rowsCountEl.textContent = total;

  pageSize = Number(pageSizeEl.value) || 20;
  const pages = Math.max(1, Math.ceil(total / pageSize));
  if (currentPage > pages) currentPage = pages;
  const start = (currentPage - 1) * pageSize;
  const visible = filtered.slice(start, start + pageSize);

  // render rows
  tbody.innerHTML = visible.map(r => {
    const sys = (r.system_balance === null) ? '-' : fmtNum(r.system_balance);
    const lead = (r.lead_time === null) ? '-' : r.lead_time;
    const availability = r.availability || '-';
    const status = r.status || '-';
    return `
      <tr>
        <td class="nowrap">${escapeHtml(r.name)}</td>
        <td class="nowrap">${escapeHtml(r.category)}</td>
        <td class="text-end nowrap">${escapeHtml(sys)}</td>
        <td class="nowrap">${escapeHtml(availability)}</td>
        <td class="nowrap">${escapeHtml(status)}</td>
        <td class="text-center nowrap">${escapeHtml(lead)}</td>
      </tr>
    `;
  }).join('');

  // pagination controls
  renderPagination(pages);
}

/* Simple HTML escape to avoid accidental injection from sheet content */
function escapeHtml(str){
  return String(str || '').replace(/[&<>"'`=]/g, s => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;","`":"&#x60;","=":"&#x3D;"}[s]));
}

function renderPagination(pages){
  const arr = [];
  for (let i=1;i<=pages;i++){
    arr.push(`<li class="page-item ${i===currentPage ? 'active' : ''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`);
  }
  paginationEl.innerHTML = arr.join('') || '';
  paginationEl.querySelectorAll('a[data-page]').forEach(a => {
    a.addEventListener('click', e => {
      e.preventDefault();
      currentPage = Number(a.dataset.page);
      renderTable(ROWS);
      window.scrollTo({top:0,behavior:'smooth'});
    });
  });
}

/* Table header sorting */
document.querySelectorAll('#itemsTable thead th').forEach(th=>{
  th.addEventListener('click', () => {
    const key = th.dataset.key;
    if (!key) return;
    if (sortKey === key) sortDir = -sortDir; else { sortKey = key; sortDir = 1; }
    renderTable(ROWS);
  });
});

/* ============================
   Charts: prepare & render
   ============================ */

/* Main entry: destroys previous charts and rerenders */
function renderCharts(data){
  // destroy previous charts to avoid duplicates
  Object.keys(charts).forEach(k => {
    if (charts[k]) {
      try { charts[k].destroy(); } catch(e){}
      charts[k] = null;
    }
  });

  // prepare datasets
  const catData = prepareCategoryChartData(data);
  const healthData = prepareHealthChartData(data);
  const delayData = prepareDelayChartData(data);

  // render or show empty states
  renderCategoryChart(catData);
  renderHealthChart(healthData);
  renderDelayChart(delayData);
}

/* Prepare Category chart data
   returns { labels:[], values:[], colors:[] } */
function prepareCategoryChartData(data){
  const counts = {};
  data.forEach(d => {
    const c = (d.category || 'Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙ').trim() || 'Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙ';
    counts[c] = (counts[c]||0) + 1;
  });
  const labels = Object.keys(counts).sort((a,b)=>counts[b]-counts[a]);
  const values = labels.map(l => counts[l]);
  const colors = labels.map((_,i) => {
    // use gradient-ish interpolation between blue and purple
    return gradientColor(chartColors.blue, chartColors.purple, i, labels.length);
  });
  return { labels, values, colors };
}

/* Prepare Health chart data (doughnut)
   classifies items into Ù†ÙØ°Øª / Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ / Ù…ØªÙˆÙØ±
   returns { labels:[], values:[], colors:[], total }
*/
function prepareHealthChartData(data){
  let out = 0, near = 0, ok = 0;
  data.forEach(d => {
    const av = (d.availability || '').toLowerCase();
    const st = (d.status || '').toLowerCase();
    if (av.includes('Ù†ÙØ°Øª') || st.includes('Ù†ÙØ°Øª') || (d.system_balance !== null && d.system_balance <= 0)) { out++; return; }
    if (av.includes('Ø¹Ù„ÙŠ ÙˆØ´Ùƒ') || av.includes('Ø¹Ù„Ù‰ ÙˆØ´Ùƒ') || st.includes('Ø¹Ù„ÙŠ ÙˆØ´Ùƒ') || st.includes('Ø¹Ù„Ù‰ ÙˆØ´Ùƒ') || (d.system_balance !== null && d.system_balance > 0 && d.system_balance <= 5)) { near++; return; }
    ok++;
  });
  const labels = ['Ù†ÙØ°Øª Ø§Ù„ÙƒÙ…ÙŠØ©','Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡','Ù…ØªÙˆÙØ±'];
  const values = [out, near, ok];
  const colors = [chartColors.red, chartColors.orange, chartColors.green];
  const total = out + near + ok;
  return { labels, values, colors, total };
}

/* Prepare Delay chart data (horizontal bars)
   Top 8 items by lead_time (largest), returns { labels, values, colors }
*/
function prepareDelayChartData(data){
  const withLead = data.filter(d => d.lead_time !== null && !isNaN(d.lead_time));
  const sorted = withLead.sort((a,b)=>b.lead_time - a.lead_time).slice(0,8);
  const labels = sorted.map(d => d.name);
  const values = sorted.map(d => d.lead_time);
  const colors = values.map((v,i) => gradientColor(chartColors.red, chartColors.orange, i, values.length));
  return { labels, values, colors };
}

/* Helper to create a CSS-like gradient color between two hex colors */
function gradientColor(hex1, hex2, idx, total){
  function hexToRgb(hex){ const m = hex.replace('#',''); return [parseInt(m.substr(0,2),16),parseInt(m.substr(2,2),16),parseInt(m.substr(4,2),16)]; }
  const c1 = hexToRgb(hex1), c2 = hexToRgb(hex2);
  const t = (total<=1) ? 0.5 : (idx/(total-1 || 1));
  const r = Math.round(c1[0] + (c2[0]-c1[0])*t), g = Math.round(c1[1] + (c2[1]-c1[1])*t), b = Math.round(c1[2] + (c2[2]-c1[2])*t);
  return `rgb(${r},${g},${b})`;
}

/* =====================
   Chart renderers
   ===================== */

function renderCategoryChart(catData){
  const canvas = document.getElementById('categoryChart');
  const ctx = canvas.getContext('2d');
  const emptyEl = document.getElementById('catEmpty');
  if (!catData.labels.length){
    emptyEl.style.display = 'block';
    canvas.style.display = 'none';
    return;
  } else {
    emptyEl.style.display = 'none';
    canvas.style.display = 'block';
  }

  // create gradient per bar using plugin-like approach: Chart.js supports array of colors
  charts.category = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: catData.labels,
      datasets: [{
        data: catData.values,
        backgroundColor: catData.colors,
        borderRadius: 12,
        barThickness: 28
      }]
    },
    options: {
      indexAxis: 'x',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display:false },
        tooltip: {
          callbacks: {
            label: context => {
              const total = catData.values.reduce((a,b)=>a+b,0) || 1;
              const pct = Math.round((context.raw / total) * 100);
              return ` ${context.formattedValue} ØµÙ†Ù (${pct}%)`;
            }
          }
        }
      },
      scales: {
        x: { ticks: { color: 'var(--text)' }, grid: { display:false } },
        y: { beginAtZero:true, ticks: { color: 'var(--text)' }, grid: { color: 'rgba(0,0,0,0.04)' } }
      },
      animation: { duration: 800, easing: 'easeOutQuart' }
    }
  });
}

function renderHealthChart(healthData){
  const canvas = document.getElementById('healthChart');
  const emptyEl = document.getElementById('healthEmpty');
  const legendEl = document.getElementById('healthLegend');
  const ctx = canvas.getContext('2d');

  if (healthData.total === 0){
    emptyEl.style.display = 'block';
    canvas.style.display = 'none';
    legendEl.innerHTML = '';
    return;
  } else {
    emptyEl.style.display = 'none';
    canvas.style.display = 'block';
  }

  // center text plugin (shows total items)
  const centerTextPlugin = {
    id: 'centerText',
    beforeDraw(chart){
      const {ctx, chartArea} = chart;
      const centerX = (chartArea.left + chartArea.right) / 2;
      const centerY = (chartArea.top + chartArea.bottom) / 2;
      ctx.save();
      ctx.font = '700 16px Cairo, sans-serif';
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text') || '#0b2230';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(`${healthData.total}`, centerX, centerY - 8);
      ctx.font = '400 12px Cairo, sans-serif';
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted') || '#6c757d';
      ctx.fillText('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ±', centerX, centerY + 14);
      ctx.restore();
    }
  };

  charts.health = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: healthData.labels,
      datasets: [{
        data: healthData.values,
        backgroundColor: healthData.colors,
        hoverOffset: 8,
        borderWidth: 0
      }]
    },
    options: {
      cutout: '65%',
      plugins: {
        legend: { display:false },
        tooltip: { callbacks: { label: context => `${context.label}: ${context.formattedValue}` } }
      },
      animation: { duration: 700, easing: 'easeOutQuart' }
    },
    plugins: [centerTextPlugin]
  });

  // render a simple legend HTML (keeps it clearer on dark backgrounds)
  legendEl.innerHTML = healthData.labels.map((lab,i) => {
    const color = healthData.colors[i];
    const val = healthData.values[i];
    return `<div class="legend-item" role="presentation"><span class="legend-swatch" style="background:${color}"></span> ${escapeHtml(lab)} â€” <strong style="color:var(--text);margin-inline-start:6px">${fmtNum(val)}</strong></div>`;
  }).join('');
}

function renderDelayChart(delayData){
  const canvas = document.getElementById('delayChart');
  const emptyEl = document.getElementById('delayEmpty');
  const ctx = canvas.getContext('2d');

  if (!delayData.labels.length){
    emptyEl.style.display = 'block';
    canvas.style.display = 'none';
    return;
  } else {
    emptyEl.style.display = 'none';
    canvas.style.display = 'block';
  }

  charts.delay = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: delayData.labels,
      datasets: [{
        data: delayData.values,
        backgroundColor: delayData.colors,
        borderRadius: 10,
        barThickness: 14
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display:false },
        tooltip: { callbacks: { label: context => `${context.label}: ${context.formattedValue} ÙŠÙˆÙ…` } }
      },
      scales: {
        x: { display: true, grid: { display:false }, ticks: { color: 'var(--text)' } },
        y: { ticks: { color: 'var(--text)' }, grid: { display:false } }
      },
      animation: { duration: 700, easing: 'easeOutQuart' }
    }
  });
}

/* ==================
   Top-level rendering
   ================== */
function calculateAndRenderAll(){
  // 1) KPIs
  const kpis = calculateKPIs(ROWS);
  renderKPIs(kpis);

  // 2) table
  renderTable(ROWS);

  // 3) charts
  renderCharts(ROWS);
}

/* ==============================
   Event bindings & initial fetch
   ============================== */

btnRefresh.addEventListener('click', ()=> {
  fetchData();
});

searchBox.addEventListener('input', ()=>{
  currentPage = 1;
  renderTable(ROWS);
});

pageSizeEl.addEventListener('change', ()=>{
  currentPage = 1;
  renderTable(ROWS);
});

/* Initial fetch when page loads. */
fetchData();

/* ==============================
   NOTES
   - JSON response expected (example provided by you) is supported: keys like
     "Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ \\ Ù…Ø±Ø¬Ø¹ Ø¯Ø§Ø®Ù„ÙŠ", "Ù…Ø¯Ø© Ø§Ù„ØªÙˆØ±ÙŠØ¯ Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨", "Ø±ØµÙŠØ¯ Ø§Ù„Ø³ÙŠØ³ØªÙ…" etc.
   - If charts still appear blank, open DevTools console to see any parsing errors;
     most common cause is a malformed JSON from the API or unexpected field names.
   - To add more visualizations (stacked bars, time trends), we can:
     1) add a "trend over time" endpoint in the Apps Script that returns historical snapshots
     2) render a line chart with multiple snapshots for each KPI
   ============================== */

</script>
</body>
</html>
